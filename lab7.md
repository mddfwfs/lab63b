# การทดลองที่ 7 เรื่อง การเขียนโปรแกรมเพื่อควบคุมการเปิด-ปิดหน้าต่างอัตโนมัติเมื่อฝนตก
## วัตถุประสงค์

1.เพื่อศึกษาการเขียนโปรแกรมควบคุมอุปกรณ์ผ่านไวไฟ

2.เพื่อศึกษาการเขียน Code รวมถึงการปรับเปลี่ยนและแก้ไขให้มีประสิทธิภาพมากขึ้น

3.เพื่อศึกษาการประยุกต์การเขียนโปรแกรมให้สอดคล้องกับการทำงานของไมโครคอนโทรเลอร์

## อุปกรณ์ที่ใช้

1.ไมโครคอนโทรเลอร์ ESP-01 

2.อุปกรณ์ต่อ USB เพื่อไปยัง serial

3.อแดปเตอร์ที่ต่อสายพอร์ท 0 (สีขาว) กับ พอร์ท 2 (สีเหลือง)

4.รีเลย์

5.เซนเซอร์ตรวจจับน้ำ

6.หน้าต่างบานเลื่อน

7.CPU

8.บอร์ด Arduino

## ศึกษาข้อมูลเบื้องต้น

- โครงงานหน้าต่างปิดอัตโนมัติเมื่อฝนตก : https://docs.google.com/document/d/0B9t7Jao3qc0sVkRDMGN4aFladlE

- run relay https://www.youtube.com/watch?v=6JnhaUILGuw

- รีเรย์ http://www.psptech.co.th/

- code ของโปรแกรม 03_Output-Port https://github.com/choompol-boonmee/lab63b/blob/master/examples/03_Output-Port/src/main.cpp

- run example 4 https://youtu.be/nFqoZT26U5k

- code ของโปรแกรม 04_Input-Port : https://github.com/choompol-boonmee/lab63b/blob/master/examples/04_Input-Port/src/main.cpp

- run wifi https://youtu.be/VX-QNQcO-b4

- code ของโปรแกรม 05_run_wifi https://github.com/choompol-boonmee/lab63b/blob/master/examples/05_Wifi-Web-Server/src/main.cpp

### วิธีทำการทดลอง

1.นำไมโครคอนโทรเลอร์ เสียบเข้าไปใน USB serial port

2.เปิดโปรแกรม cmd

3.เปิดโฟลเดอร์ pattani โดยใช้คำสั่ง **cd pattani**

4.ศึกษาโปรแกรมตัวอย่างของอาจารย์

- 03_Output-Port

- 04_Input-Port

- 05_run_wifi

5.นำตัวอย่างโปรแกรมที่เราศึกษามาประยุกต์ เขียนโปรแกรมที่เราต้องการทดลอง

6.ใช้คำสั่ง **cd 03_Output-Port**

7.ใช้คำสั่ง **vi src/main.cpp** จะขึ้นโค้ดดังนี้

```
#include <Arduino.h>
#include <ESP8266WiFi.h>

int cnt = 0;

void setup()
{
	Serial.begin(115200);
	pinMode(0, OUTPUT);
	Serial.println("\n\n\n");
}

void loop()
{
	cnt++;
	if(cnt % 2) {
		Serial.println("========== ON ===========");
		digitalWrite(0, HIGH);
	} else {
		Serial.println("========== OFF ===========");
		digitalWrite(0, LOW);
	}
	delay(500);
}

```

โค้ดของโปรแกรมนี้ได้เซตที่พอร์ท 0 คือ พอร์ทเอ้าพุต และมีคำสั่งวนลูปทุกๆ 500 ms โดยจะนับ cnt ไปเรื่อยๆโดยที่เมือ cnt เลขคู่เป็น off และคี่เป็น on 

8.อัพโหลดโปรแกรมเข้าไมโครคอนโทรเลอร์โดยการใช้คำสั่ง **pio run-t upload**

9.กดปุ่มอัพโหลดและรีเซตที่ตัวไมโทรคอนโทรเลอร์เพื่อให้ตัวโปรแกรมอัพโหลดเข้าไปในตัว microcontroller

10.**pio device monitor** แล้วดูผลลัพท์

11.นำ microcontroller ที่เขียนโปรแกรมไว้แล้วมาต่อเข้ากับตัวรีเรย์

12.เลือกตัวอย่างโปรแกรมคำสั่ง **cd 04_Input-Port**

13.พิมพ์คำสั่ง **vi src/main.cpp** เมื่อกด Enter จะขึ้นโค้ดดังนี้

```
#include <Arduino.h>
#include <ESP8266WiFi.h>

int cnt = 0;

void setup()
{
	Serial.begin(115200);
	pinMode(0, INPUT);
	pinMode(2, OUTPUT);
	Serial.println("\n\n\n");
}

void loop()
{
	int val = digitalRead(0);
	Serial.printf("======= read %d\n", val);
	if(val==1) {
		digitalWrite(2, LOW);
	} else {
		digitalWrite(2, HIGH);
	}
	delay(100);
}

```

โดยโค้ดของโปรแกรมนี้ได้เซตที่พอร์ท 0 คือ input พอร์ท 2 คือ output และ อ่านจะอ่านข้อมูลจากพอร์ท 0 โดยให้เป็นข้อมูลดิจิทัล(มีค่า 0 1) และแสดงผลว่าอ่านได้เท่าไหร่โดยถ้าเป็น 1 จะเป็นค่า low ที่พอร์ท 2 และถ้าเป็น 0 จะเป็นค่า high ที่พอร์ท 2

14.กดปุ่มอัพโหลดที่ตัวไมโครคอนโทรลเลอร์เพื่อให้ตัวโปรแกรมอัพโหลดเข้าไปในตัวไมโครคอนโทรลเลอร์

15.เปิดโปรแกรม cmd 

16.อัพโหลดโค้ดใส่ไมโครคอนโทรเลอร์ โดยโค้ดเป็นดังนี้

```

#include <ESP8266WiFi.h> 
//#include <WiFiClient.h>
#include <ESP8266WebServer.h>

const char* ssid = "Toey-Fern";
const char* password = "13121313";


ESP8266WebServer server(80);

int cnt = 0;

void setup(void){
	Serial.begin(115200);

	WiFi.mode(WIFI_STA);
	WiFi.begin(ssid, password);
	while (WiFi.status() != WL_CONNECTED) {
		delay(500);
		Serial.print(".");
	}
	Serial.print("\n\nIP address: ");
	Serial.println(WiFi.localIP());

	server.onNotFound([]() {
		server.send(404, "text/plain", "Path Not Found");
	});

	/// http://192.0.0.1/ = Hello cnt: ???
	server.on("/", []() {
		cnt++;
		String msg = "Hello cnt: ";
		msg += cnt;
		server.send(200, "text/plain", msg);
	});
	/// http://192.0.0.1/on = Hello cnt: ???
	server.on("/on", []() {
		cnt++;
		String msg = "Switch on ";
		msg += cnt;
		server.send(200, "text/plain", msg);
	});
	/// http://192.0.0.1/off = Switch off: ???
	server.on("/off", []() {
		cnt++;
		String msg = "Hello cnt: ";
		msg += cnt;
		server.send(200, "text/plain", msg);
	});

	server.begin();
	Serial.println("HTTP server started");
}

```

เนื่องจากโปรแกรมเชื่อมต่อกับไวไฟดังนั้นต้องใส่ชื่อ wifi และ passwordก่อน ได้แก่

- Setup เป็นการ connect กับไวไฟที่เราใส่ชื่อไว้ตอนแรก และ Setup webserver 

17.อัพโหลดโปรแกรมเข้าไมโครคอนโทรเลอร์โดยการใช้คำสั่ง **pio run-t upload**

18.ต่อไมโครคอนโทรเลอร์เข้ากับคอมพิวเตอร์ด้วยการต่อ USBไปยังSerial

19.กดปุ่มอัพโหลดและกดปุ่มรีเซตที่ตัวไมโครคอนโทรเลอร์เพื่อให้ตัวโปรแกรมอัพโหลดเข้าไปในตัวไมโครคอนโทรเลอร์

20.pio device monitor เพื่อดูผลลัพธ์

21.ต่อมาจะขึ้น ip address ให้ copy ip address ไปบราวเซอร์ในการทดสอบแล้วบันทึกผล

22.ติดตั้งมอเตอร์เกียไว้กับโครงร่างหน้าต่าง

23.ติดตั้งรีเลย์ปิด รีเลย์เปิด ที่เขียนโปรแกรมไว้กับไมโครคอนโทรเลอร์ และหม้อแปลง

24.ติดตั้งลิมิตสวิตซ์ไว้ที่ขอบหน้าต่าง

25.ต่อสายไฟจากหม้อแปลงมาที่รีเลย์ปิด และต่อสายไฟจากรีเลย์ปิดไปที่รีเลย์เปิดตามแผงวงจร

26.ต่อสายไฟจากลิมิตสวิตซ์มาที่รีเลย์ โดยลิมิตสวิตซ์เปิดต่อมาที่รีเลย์ปิด และลิมิตสวิตซ์ปิดมาที่รีเลย์เปิด เพื่อลิมิตสวิตซ์จะตัดวงจรอีกตัวไม่ให้ทำงาน

27.ติดตั้งเซนเซอร์ตรวจจับน้ำ ต่อสายไฟจากรีเลย์ 5V ของเซนเซอร์ เข้ากลับรีเลย์ 12V ให้ถูกขั้วบวก-ลบ และต่อสายเข้าไปกับสวิตซ์เปิดหน้าต่าง

28.ติดตั้งสวิตซ์สำหรับเปิดปิดหน้าต่างเอง

29.นำinputต่อกับสัญญาณจากcensor

- ถ้าหน้าเซนเซอร์สัมผัสน้ำ input เป็น 0 หน้าต่างเลื่อนปิด

- ถ้าหน้าเซนเซอร์ไม่สัมผัสน้ำ input เป็น 1 หน้าต่างไม่เกิดการเลื่อน

30.นำโปรแกรมที่เชื่อมต่อกับไวไฟและเว็บเซิร์ฟเวอร์มาช่วยในการควบคุมการทำงานของรีเลย์ ช่วยให้การเลื่อนของหน้าต่างปิดเร็วขึ้น

#### การบันทึกผลการทดลอง

เมื่อทดสอบการทำงานของหน้าต่างด้วยการฉีดละอองน้ำให้ไปกระทบเซนเวอร์ทำให้หน้าต่างเลื่อนปิดอัตโนมัติ โดยปริมาณน้ำที่ต่างกัน ระยะเวลาการทำงานของมอเตอร์ต่างกัน เมื่อมีน้ำที่หน้าเซนเซอร์น้อย มอเตอร์จะทำงานช้า  
แต่ถ้ามีน้ำมากระทบเซนเซอร์มากขึ้น มอเตอร์จะทำเร็วขึ้น และจากการเชื่อมต่อเว็บเซิร์ฟเวอร์ที่ช่วยในการทำงานของมอเตอร์ ทำให้มอเตอร์ทำงานช้า-เร็วตามที่เราควบคุมไว้ในโปรแกรม

#### อภิปรายผลการทดลอง

จากการประดิษฐ์หน้าต่างปิดอัตโนมัติ โดยทดสอบการเลื่อนปิดอัตโนมัติของหน้าต่าง เมื่อมีฝนตกลงมากระทบเซนเซอร์ตรวจจับน้ำ 
ปรากฏว่า หน้าต่างนั้นจะสามารถเลื่อนปิดอัตโนมัติได้ และเมื่อมีปริมาณฝนที่แตกต่างกัน ก็จะทำให้ระยะเวลาการทำงานของมอเตอร์นั้นแตกต่างกัน และโปรแกรมเว็บเซิร์ฟเวอร์ที่เราเชื่อมต่อไว้ช่วยในการทำงานของมอเตอร์

#### คำถามหลังการทดลอง


